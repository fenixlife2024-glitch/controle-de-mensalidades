<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Gest√£o Financeira Acad√™mica - Oficial</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root { --primary: #1e293b; --accent: #3b82f6; --success: #22c55e; --warning: #eab308; --danger: #ef4444; --bg: #f8fafc; --sidebar-w: 240px; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); margin: 0; padding: 0; color: #334155; display: flex; height: 100vh; overflow: hidden; }
        
        .sidebar { 
            width: var(--sidebar-w); 
            background: var(--primary); 
            color: white; 
            display: none; 
            flex-direction: column; 
            z-index: 1001; 
            transition: all 0.3s ease;
            overflow: hidden;
            white-space: nowrap;
        }
        .sidebar.collapsed { width: 0; min-width: 0; }

        .sidebar-header { padding: 20px; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 14px; text-transform: uppercase; }
        .sidebar-menu { flex-grow: 1; padding: 10px 0; }
        .menu-item { padding: 12px 20px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s; font-size: 14px; }
        .menu-item:hover, .menu-item.active { background: var(--accent); color: white; }
        
        .view-container { flex-grow: 1; display: none; flex-direction: column; padding: 25px; overflow-y: auto; height: 100vh; box-sizing: border-box; transition: padding 0.3s ease; }
        .view-active { display: flex; }
        
        .config-bar { background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #e2e8f0; display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 12px; align-items: flex-end; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .input-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-size: 10px; font-weight: 700; text-transform: uppercase; color: #64748b; }
        .form-control { padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 13px; outline: none; width: 100%; box-sizing: border-box; }
        
        select[multiple].form-control { height: 60px; padding: 4px; }

        .dash-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-left: 5px solid var(--accent); }
        .card h4 { margin: 0 0 10px 0; font-size: 12px; color: #64748b; text-transform: uppercase; }
        .card .val { font-size: 24px; font-weight: 800; color: var(--primary); }
        
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; }
        th { background: #f1f5f9; color: #475569; padding: 12px; text-align: left; font-size: 11px; text-transform: uppercase; border-bottom: 2px solid #e2e8f0; position: sticky; top: 0; }
        td { padding: 10px 12px; border-bottom: 1px solid #f1f5f9; font-size: 13px; }
        
        tr.row-pago { background-color: #f0fdf4 !important; }
        tr.row-enviado { background-color: #fffbeb !important; }
        tr.row-invalido { background-color: #fef2f2 !important; }
        .nome-doc-pendente { background-color: #fef08a !important; color: #854d0e !important; padding: 2px 5px; border-radius: 4px; }

        .mes-box { width: 24px; height: 24px; border-radius: 5px; border: 1px solid #cbd5e1; display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: bold; cursor: pointer; }
        .mes-pago { background: var(--success); color: white; border-color: #16a34a; }
        .mes-pendente { background: #f1f5f9; color: #94a3b8; }
        
        .btn { border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 11px; display: inline-flex; align-items: center; gap: 6px; transition: 0.2s; text-decoration: none; }
        .btn-zap { background: #25D366; color: white; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        
        .btn-toggle { background: none; border: none; cursor: pointer; font-size: 20px; color: var(--primary); padding: 5px; margin-right: 15px; display: flex; align-items: center; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.7); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .modal-content { background: white; padding: 25px; border-radius: 16px; width: 95%; max-width: 550px; max-height: 90vh; overflow-y: auto; }
        #login-screen { position: fixed; inset: 0; background: var(--primary); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .star-icon, .doc-icon { cursor: pointer; font-size: 18px; color: #cbd5e1; transition: 0.2s; text-decoration: none; }
        .star-active { color: #f59e0b !important; }
        .doc-active { color: var(--danger) !important; }
        .grid-form { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box" style="background:white; padding:40px; border-radius:16px; width:300px;">
        <h2 style="text-align:center; margin-top:0;">Login</h2>
        <input type="email" id="loginEmail" placeholder="E-mail" class="form-control" style="margin-bottom:15px;">
        <input type="password" id="loginPass" placeholder="Senha" class="form-control" style="margin-bottom:20px;">
        <button id="btnLogin" style="background:var(--accent); color:white; border:none; padding:12px; border-radius:8px; cursor:pointer; font-weight:bold; width:100%;">Entrar</button>
    </div>
</div>

<div class="sidebar" id="mainSidebar">
    <div class="sidebar-header">Fluxo de Cobran√ßa</div>
    <div class="sidebar-menu">
        <div class="menu-item active" onclick="trocarTela('mainContainer')">üìÇ Operacional</div>
        <div class="menu-item" onclick="trocarTela('painelGestao')">üìä Relat√≥rios Dire√ß√£o</div>
    </div>
</div>

<div class="view-container view-active" id="mainContainer">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px;">
        <div style="display:flex; align-items:center;">
            <button class="btn-toggle" onclick="toggleSidebar()">‚ò∞</button>
            <h1 style="margin:0; font-size: 22px; font-weight: 800;">Painel de Cobran√ßa</h1>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
            <button onclick="abrirModalCadastro()" class="btn btn-primary">‚ûï Novo Aluno</button>
            <button onclick="editarSelecionado()" class="btn btn-warning" style="background:#6366f1">‚úèÔ∏è Editar 1</button>
            <button onclick="abrirModalLote()" class="btn btn-warning" style="background:#f59e0b">üìÖ Venc. Lote</button>
            <button onclick="resetarStatusEnvio()" class="btn btn-warning">üîÑ Resetar Status</button>
            <button onclick="excluirSelecionados()" class="btn btn-danger">üóëÔ∏è Deletar</button>
            <span id="contador" style="font-weight:700; color:var(--accent); font-size:11px; background:#e0f2fe; padding:5px 10px; border-radius:20px;">Sincronizando...</span>
        </div>
    </div>
    
    <div class="config-bar">
        <div class="input-group">
            <label>Per√≠odo</label>
            <select id="semestreSelect" class="form-control" onchange="carregarDados()">
                <option value="all">Ano Completo</option>
                <option value="1">1¬∫ Semestre</option>
                <option value="2">2¬∫ Semestre</option>
            </select>
        </div>
        <div class="input-group"><label>Ano</label><input type="number" id="anoRef" class="form-control" value="2026"></div>
        
        <div class="input-group">
            <label>Unidades (Ctrl + Clique)</label>
            <select id="filtroUnidade" class="form-control" multiple onchange="renderizar(); renderizarPainel();"></select>
        </div>
        
        <div class="input-group">
            <label>Status (Ctrl + Clique)</label>
            <select id="filtroStatusEnvio" class="form-control" multiple onchange="renderizar()">
                <option value="Pendente">‚è≥ Pendentes</option>
                <option value="Enviado">üì§ Enviados</option>
                <option value="Pago">‚úÖ Pagos</option>
                <option value="N√∫mero Inv√°lido">üö´ Inv√°lidos</option>
            </select>
        </div>

        <div class="input-group">
            <label>Marcador ‚òÖ</label>
            <select id="filtroMarcado" class="form-control" onchange="renderizar()">
                <option value="todos">Todos</option>
                <option value="marcados">Estrela ‚òÖ</option>
            </select>
        </div>
        <div class="input-group"><label>Categoria</label><select id="filtroCategoria" class="form-control" onchange="renderizar(); renderizarPainel();"><option value="">Todas</option><option value="PTC">PTC</option><option value="Extranet">Extranet</option></select></div>
        <div class="input-group"><label>Prazo 9% Off</label><input type="text" id="prazoCampanha" class="form-control" value="08/01" oninput="renderizar()"></div>
        <div class="input-group"><label style="color:var(--accent)">Importar CSV</label><input type="file" id="csvInput" accept=".csv" class="form-control" onchange="importarCSV(this)"></div>
    </div>

    <input type="text" id="busca" placeholder="Pesquisar por nome ou RA..." class="form-control" style="width:100%; margin-bottom:15px; padding:12px;" onkeyup="renderizar()">
    
    <div style="flex-grow:1; overflow:auto; background:white; border-radius:12px; border:1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);">
        <table>
            <thead><tr><th style="width:20px;"><input type="checkbox" onclick="toggleTodos(this)"></th><th style="width:30px;">‚òÖ</th><th style="width:30px;">Doc</th><th>RA</th><th>Nome do Aluno</th><th>Meses</th><th>Status</th><th>WhatsApp</th><th>Lembrete</th></tr></thead>
            <tbody id="corpoTabela"></tbody>
        </table>
    </div>
</div>

<div id="modal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 id="modalTitle" style="margin:0; font-size:18px;">Dados do Aluno</h3>
            <button onclick="fecharModal()" style="border:none; background:none; cursor:pointer; font-size:28px; color:#94a3b8;">&times;</button>
        </div>
        <div class="grid-form">
            <div class="input-group"><label>RA (√önico)</label><input type="text" id="mRA" class="form-control"></div>
            <div class="input-group"><label>Nome Completo</label><input type="text" id="mNome" class="form-control"></div>
            <div class="input-group"><label>WhatsApp (DDD+N√∫mero)</label><input type="text" id="mTel" class="form-control"></div>
            <div class="input-group"><label>Unidade</label><input type="text" id="mUnidade" class="form-control"></div>
            <div class="input-group"><label>Categoria</label><select id="mCategoria" class="form-control"><option value="Extranet">Extranet</option><option value="PTC">PTC</option></select></div>
            <div class="input-group"><label>Status de Envio</label><select id="mStatusEnvio" class="form-control"><option value="Pendente">Pendente</option><option value="Enviado">Enviado</option><option value="Pago">Pago</option><option value="N√∫mero Inv√°lido">Inv√°lido</option></select></div>
        </div>
        <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">
        <label style="margin-bottom:10px; display:block; font-weight:bold;">Vencimentos das Mensalidades:</label>
        <div id="listaMensalidades" style="display:flex; flex-direction:column; gap:8px; margin-bottom:20px;"></div>
        <button onclick="salvarAluno()" class="btn btn-primary" style="width:100%; padding:12px; justify-content:center; font-size:14px;">üíæ Salvar Informa√ß√µes</button>
    </div>
</div>

<div id="modalLote" class="modal">
    <div class="modal-content" style="max-width: 400px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="margin:0; font-size:18px;">Vencimento em Lote</h3>
            <button onclick="fecharModalLote()" style="border:none; background:none; cursor:pointer; font-size:28px; color:#94a3b8;">&times;</button>
        </div>
        <div class="input-group" style="margin-bottom:15px;">
            <label>M√™s para Atualizar</label>
            <select id="loteMes" class="form-control">
                <option value="1">Janeiro</option><option value="2">Fevereiro</option><option value="3">Mar√ßo</option>
                <option value="4">Abril</option><option value="5">Maio</option><option value="6">Junho</option>
                <option value="7">Julho</option><option value="8">Agosto</option><option value="9">Setembro</option>
                <option value="10">Outubro</option><option value="11">Novembro</option><option value="12">Dezembro</option>
            </select>
        </div>
        <div class="input-group" style="margin-bottom:20px;">
            <label>Nova Data de Vencimento</label>
            <input type="date" id="loteData" class="form-control">
        </div>
        <button onclick="salvarLoteVencimento()" class="btn btn-primary" style="width:100%; padding:12px; justify-content:center;">üíæ Aplicar aos Selecionados</button>
    </div>
</div>

<div class="view-container" id="painelGestao">
    <div style="display:flex; align-items:center; margin-bottom: 25px;">
        <button class="btn-toggle" onclick="toggleSidebar()">‚ò∞</button>
        <h1 style="margin:0; font-size: 22px; font-weight: 800;">Relat√≥rios Executivos</h1>
        <div style="display:flex; gap:10px; align-items:flex-end; margin-left: auto;">
            <div class="input-group">
                <label>M√™s Ref.</label>
                <select id="mesRefDash" class="form-control" onchange="renderizarPainel()"></select>
            </div>
            <button onclick="gerarRelatorioPDF()" class="btn btn-primary" style="padding:12px 25px;">üìÑ PDF Diretoria</button>
        </div>
    </div>
    <div class="dash-grid">
        <div class="card"><h4>Total Clientes</h4><span class="val" id="d-total">0</span></div>
        <div class="card" style="border-left-color: var(--success)"><h4>Pagos (M√™s)</h4><span class="val" id="d-pag-mes">0</span></div>
        <div class="card" style="border-left-color: var(--danger)"><h4>Em Atraso</h4><span class="val" id="d-atraso">0</span></div>
        <div class="card" style="border-left-color: var(--warning)"><h4>Enviados</h4><span class="val" id="d-env">0</span></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDocs, collection, updateDoc, writeBatch, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = { apiKey: "AIzaSyC4_dlIiCaNHtj7eWB4kW200vnO6AuuuTA", authDomain: "reguacobranca.firebaseapp.com", projectId: "reguacobranca", storageBucket: "reguacobranca.firebasestorage.app", messagingSenderId: "85201788796", appId: "1:85201788796:web:25cf11a726cec89d248ef9" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    window.alunos = {};
    const nomesMesesLongos = ["", "JANEIRO", "FEVEREIRO", "MAR√áO", "ABRIL", "MAIO", "JUNHO", "JULHO", "AGOSTO", "SETEMBRO", "OUTUBRO", "NOVEMBRO", "DEZEMBRO"];

    onAuthStateChanged(auth, user => { if (user) { document.getElementById('login-screen').style.display='none'; document.getElementById('mainSidebar').style.display='flex'; document.getElementById('mainContainer').style.display='flex'; carregarDados(); } });
    document.getElementById('btnLogin').addEventListener('click', async () => { try { await signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPass').value); } catch(e) { alert("Acesso Negado"); } });

    window.toggleSidebar = function() {
        document.getElementById('mainSidebar').classList.toggle('collapsed');
    };

    async function carregarDados() {
        const snap = await getDocs(collection(db, "alunos"));
        window.alunos = {};
        snap.forEach(doc => { window.alunos[doc.id] = doc.data(); });
        atualizarOpcoesFiltros();
        atualizarMesesReferencia();
        renderizar();
        renderizarPainel();
    }

    function atualizarMesesReferencia() {
        const sem = document.getElementById('semestreSelect').value;
        const select = document.getElementById('mesRefDash');
        let mI = 1, mF = 12;
        if(sem === "1") { mI = 1; mF = 6; }
        else if(sem === "2") { mI = 7; mF = 12; }
        select.innerHTML = '';
        for(let i=mI; i<=mF; i++) {
            const opt = document.createElement('option');
            opt.value = i;
            opt.innerText = nomesMesesLongos[i];
            if(new Date().getMonth()+1 === i) opt.selected = true;
            select.appendChild(opt);
        }
    }

    window.abrirModalCadastro = function() {
        document.getElementById('modalTitle').innerText = "Cadastrar Novo Aluno";
        document.getElementById('mRA').value = "";
        document.getElementById('mRA').disabled = false;
        document.getElementById('mNome').value = "";
        document.getElementById('mTel').value = "";
        document.getElementById('mUnidade').value = "";
        document.getElementById('mCategoria').value = "Extranet";
        document.getElementById('mStatusEnvio').value = "Pendente";
        
        const sem = document.getElementById('semestreSelect').value;
        const ano = document.getElementById('anoRef').value;
        let mI = sem==="1"?1:sem==="2"?7:1; 
        let mF = sem==="1"?6:sem==="2"?12:12;
        
        const lista = document.getElementById('listaMensalidades');
        lista.innerHTML = '';
        for(let i=mI; i<=mF; i++) {
            renderizarLinhaMensalidade({mes: i, vencimento: `${ano}-${String(i).padStart(2,'0')}-10`, pago: false}, i-mI);
        }
        document.getElementById('modal').style.display = 'flex';
    }

    window.editarSelecionado = function() {
        const selecionados = document.querySelectorAll('.chk-aluno:checked');
        if(selecionados.length !== 1) return alert("Selecione exatamente 1 aluno para editar.");
        const ra = selecionados[0].getAttribute('data-ra');
        abrirModalEdicao(ra);
    }

    window.abrirModalEdicao = function(ra) {
        const aluno = window.alunos[ra];
        document.getElementById('modalTitle').innerText = "Editando: " + aluno.nome;
        document.getElementById('mRA').value = aluno.ra;
        document.getElementById('mRA').disabled = true;
        document.getElementById('mNome').value = aluno.nome;
        document.getElementById('mTel').value = aluno.tel;
        document.getElementById('mUnidade').value = aluno.unidade;
        document.getElementById('mCategoria').value = aluno.categoria || "Extranet";
        document.getElementById('mStatusEnvio').value = aluno.controleEnvio || "Pendente";
        
        const lista = document.getElementById('listaMensalidades');
        lista.innerHTML = '';
        aluno.mensalidades.forEach((m, idx) => {
            renderizarLinhaMensalidade(m, idx);
        });
        document.getElementById('modal').style.display = 'flex';
    }

    function renderizarLinhaMensalidade(m, idx) {
        const div = document.createElement('div');
        div.style = 'display:flex; justify-content:space-between; align-items:center; padding:5px; border-bottom:1px solid #f1f5f9; gap:10px;';
        div.innerHTML = `
            <span style="font-size:12px; font-weight:600; width:60px;">M√™s ${m.mes}</span>
            <input type="date" value="${m.vencimento}" class="form-control m-venc" data-mes="${m.mes}" style="width:140px;">
            <label style="font-size:9px; display:flex; align-items:center; gap:4px;">
                <input type="checkbox" class="m-pago" ${m.pago?'checked':''}> Pago
            </label>
        `;
        document.getElementById('listaMensalidades').appendChild(div);
    }

    window.salvarAluno = async function() {
        const ra = document.getElementById('mRA').value.replace(/\D/g, '');
        if(!ra) return alert("RA √© obrigat√≥rio");
        const mensalidades = [];
        document.querySelectorAll('#listaMensalidades > div').forEach(div => {
            mensalidades.push({
                mes: parseInt(div.querySelector('.m-venc').getAttribute('data-mes')),
                vencimento: div.querySelector('.m-venc').value,
                pago: div.querySelector('.m-pago').checked,
                ano: document.getElementById('anoRef').value
            });
        });
        const dados = {
            ra: ra,
            nome: document.getElementById('mNome').value.trim(),
            tel: document.getElementById('mTel').value.replace(/\D/g, ''),
            unidade: document.getElementById('mUnidade').value.trim(),
            categoria: document.getElementById('mCategoria').value,
            controleEnvio: document.getElementById('mStatusEnvio').value,
            marcado: window.alunos[ra]?.marcado || false,
            docPendente: window.alunos[ra]?.docPendente || false,
            mensalidades: mensalidades
        };
        try {
            await setDoc(doc(db, "alunos", ra), dados);
            window.alunos[ra] = dados;
            fecharModal();
            renderizar();
            renderizarPainel();
            atualizarOpcoesFiltros();
            alert("Dados salvos com sucesso!");
        } catch (e) { alert("Erro ao salvar: " + e.message); }
    }

    window.renderizar = function() {
        const t = document.getElementById('corpoTabela');
        const b = document.getElementById('busca').value.toLowerCase();
        
        const fUni = Array.from(document.getElementById('filtroUnidade').selectedOptions).map(opt => opt.value);
        const fStatus = Array.from(document.getElementById('filtroStatusEnvio').selectedOptions).map(opt => opt.value);
        
        const fCat = document.getElementById('filtroCategoria').value;
        const fMarcado = document.getElementById('filtroMarcado').value;
        
        const lista = Object.values(window.alunos).filter(a => {
            const status = a.controleEnvio || 'Pendente';
            const matchUni = fUni.length === 0 || fUni.includes(a.unidade);
            const matchStatusEnvio = fStatus.length === 0 || fStatus.includes(status);
            const matchCat = (!fCat || a.categoria === fCat);
            const matchBusca = (a.nome?.toLowerCase().includes(b) || a.ra.includes(b));
            const matchMarcado = (fMarcado === 'todos' || (fMarcado === 'marcados' && a.marcado));
            return matchUni && matchStatusEnvio && matchCat && matchBusca && matchMarcado;
        }).sort((x,y) => x.nome.localeCompare(y.nome));

        t.innerHTML = '';
        lista.forEach(a => {
            const status = a.controleEnvio || 'Pendente';
            const tr = document.createElement('tr');
            tr.className = status==='Pago'?'row-pago':status==='Enviado'?'row-enviado':status==='N√∫mero Inv√°lido'?'row-invalido':'';
            const classeNome = a.docPendente ? 'class="nome-doc-pendente"' : '';

            tr.innerHTML = `
                <td><input type="checkbox" class="chk-aluno" data-ra="${a.ra}"></td>
                <td><span class="star-icon ${a.marcado ? 'star-active' : ''}" onclick="toggleMarcador('${a.ra}')">‚òÖ</span></td>
                <td><span class="doc-icon ${a.docPendente ? 'doc-active' : ''}" onclick="toggleDoc('${a.ra}')">üìÑ</span></td>
                <td>${a.ra}</td>
                <td onclick="abrirModalEdicao('${a.ra}')" style="cursor:pointer; color:var(--accent); font-weight:700;"><span ${classeNome}>${a.nome}</span></td>
                <td><div style="display:flex; gap:4px; flex-wrap:wrap; max-width:200px;">${a.mensalidades.map((m,i)=>`<div class="mes-box ${m.pago?'mes-pago':'mes-pendente'}" onclick="togglePagamento('${a.ra}',${i})">${m.mes}</div>`).join('')}</div></td>
                <td>
                    <select class="form-control" onchange="alterarStatus('${a.ra}', this.value)" style="font-size:10px; height:28px; padding:2px;">
                        <option value="Pendente" ${status==='Pendente'?'selected':''}>‚è≥ Pendente</option>
                        <option value="Enviado" ${status==='Enviado'?'selected':''}>üì§ Enviado</option>
                        <option value="Pago" ${status==='Pago'?'selected':''}>‚úÖ Pago</option>
                        <option value="N√∫mero Inv√°lido" ${status==='N√∫mero Inv√°lido'?'selected':''}>üö´ Inv√°lido</option>
                    </select>
                </td>
                <td><a class="btn btn-zap" href="https://wa.me/55${a.tel}?text=${encodeURIComponent(gerarTextoZap(a))}" target="_blank" onclick="alterarStatus('${a.ra}', 'Enviado')">üì± Enviar</a></td>
                <td><a class="btn" style="background:#8b5cf6; color:white;" href="https://wa.me/55${a.tel}?text=${encodeURIComponent(gerarTexto9Off(a))}" target="_blank">üíé Lembrete</a></td>`;
            t.appendChild(tr);
        });
        document.getElementById('contador').innerText = `${lista.length} Clientes`;
    }

    window.abrirModalLote = function() {
        const selecionados = document.querySelectorAll('.chk-aluno:checked');
        if(selecionados.length === 0) return alert("Selecione os alunos na tabela primeiro.");
        document.getElementById('modalLote').style.display = 'flex';
    }

    window.fecharModalLote = () => document.getElementById('modalLote').style.display = 'none';

    window.salvarLoteVencimento = async function() {
        const mesAlvo = parseInt(document.getElementById('loteMes').value);
        const novaData = document.getElementById('loteData').value;
        const selecionados = document.querySelectorAll('.chk-aluno:checked');
        if(!novaData) return alert("Escolha uma data v√°lida.");
        if(!confirm(`Deseja alterar o vencimento do m√™s ${mesAlvo} para ${novaData} em ${selecionados.length} alunos?`)) return;
        const batch = writeBatch(db);
        selecionados.forEach(chk => {
            const ra = chk.getAttribute('data-ra');
            const aluno = window.alunos[ra];
            const mIndex = aluno.mensalidades.findIndex(m => m.mes === mesAlvo);
            if(mIndex !== -1) {
                aluno.mensalidades[mIndex].vencimento = novaData;
                batch.update(doc(db, "alunos", ra), { mensalidades: aluno.mensalidades });
            }
        });
        await batch.commit();
        alert("Vencimentos atualizados!");
        fecharModalLote();
        renderizar();
    }

    // L√ìGICA DE MENSAGENS ATUALIZADA (ENVIAR E LEMBRETE)
    window.gerarTextoZap = function(aluno) {
        const hoje = new Date(); hoje.setHours(0,0,0,0);
        const mensalidadeAtual = aluno.mensalidades?.find(m => !m.pago);
        if (!mensalidadeAtual) return `Ol√°, ${aluno.nome}! Sua situa√ß√£o est√° regularizada. ‚úÖ`;

        const [anoV, mesV, diaV] = mensalidadeAtual.vencimento.split('-');
        const dataVencOriginal = new Date(anoV, mesV - 1, diaV); dataVencOriginal.setHours(0,0,0,0);
        const mesExtenso = nomesMesesLongos[mensalidadeAtual.mes];
        
        const prazoConfigurado = document.getElementById('prazoCampanha').value; 
        const [diaP, mesP] = prazoConfigurado.split('/');
        const dataLimiteDesconto = new Date(document.getElementById('anoRef').value, parseInt(mesP) - 1, parseInt(diaP));
        dataLimiteDesconto.setHours(0,0,0,0);

        const mesesEmAtraso = aluno.mensalidades
            .filter(m => !m.pago && m.mes < mensalidadeAtual.mes)
            .map(m => nomesMesesLongos[m.mes]);

        let texto = "";

        if (mensalidadeAtual.mes === 1 || mensalidadeAtual.mes === 7) {
            texto = `Ol√°, ${aluno.nome}! Tudo bem? üéì\n\nUm novo semestre est√° batendo √† porta e com ele novas oportunidades de aprendizado e crescimento! Seu sonho da gradua√ß√£o √© o nosso combust√≠vel e queremos ver voc√™ brilhando em mais essa etapa. üåü\n\nPara garantir que voc√™ n√£o perca nenhum momento dessa evolu√ß√£o e siga firme na sua jornada acad√™mica, estamos enviando o seu boleto de *${mesExtenso}* (referente √† sua renova√ß√£o).`;
            if (hoje <= dataLimiteDesconto) {
                texto += `\n\nüí∞ *Lembre-se do seu benef√≠cio:*\nEfetuando o pagamento at√© o dia *${prazoConfigurado}*, voc√™ garante seu *desconto de pontualidade de 9% OFF*. Aproveite essa oportunidade para investir no seu futuro com economia!`;
            }
            texto += `\n\nO pagamento deste boleto √© o que oficializa sua jornada neste novo semestre e permite que voc√™ continue acessando todos os conte√∫dos e atividades sem interrup√ß√µes.`;
            if (hoje > dataLimiteDesconto) texto += ` Lembre-se que o vencimento original √© dia *${diaV}/${mesV}*.`;
        } else {
            if (hoje > dataLimiteDesconto && hoje <= dataVencOriginal) {
                texto = `Ol√°, ${aluno.nome}! üéì\n\nPassando para avisar que o prazo para o seu *desconto de pontualidade* de ${mesExtenso} encerrou no dia *${prazoConfigurado}*.\n\nMas n√£o se preocupe: seu boleto continua dispon√≠vel e o vencimento original √© apenas em *${diaV}/${mesV}*. Voc√™ ainda pode efetuar o pagamento pelo valor integral at√© essa data para evitar juros ap√≥s o vencimento.`;
            } else if (hoje <= dataLimiteDesconto) {
                texto = `Ol√°, ${aluno.nome}! Tudo bem? üéì\n\nInformamos que o seu boleto de *${mesExtenso}* j√° est√° dispon√≠vel.\n\nüí° *Prazos:*\n‚Ä¢ At√© *${prazoConfigurado}*: Pagamento com desconto (9% OFF).\n‚Ä¢ At√© *${diaV}/${mesV}*: Vencimento original (valor integral).`;
            } else {
                const diff = Math.ceil(Math.abs(hoje - dataVencOriginal) / (1000 * 60 * 60 * 24));
                texto = `Ol√°, ${aluno.nome}! Sua mensalidade de *${mesExtenso}* est√° pendente h√° ${diff} dias. Por favor, regularize no portal para evitar encargos adicionais.`;
            }
        }

        if (mesesEmAtraso.length > 0) {
            texto += `\n\n---\n‚ö†Ô∏è *Ponto de Aten√ß√£o:*\nNotamos que as mensalidades de *${mesesEmAtraso.join(' e ')}* ainda constam em aberto. √â importante regulariz√°-las para evitar que o saldo devedor se acumule e possa dificultar sua renova√ß√£o de matr√≠cula ao final do semestre.`;
        }

        texto += `\n\nO boleto segue em anexo! üìÑ`;
        return texto;
    }

    window.gerarTexto9Off = function(aluno) {
        const hoje = new Date(); hoje.setHours(0,0,0,0);
        const prazoConfigurado = document.getElementById('prazoCampanha').value; 
        const [diaP, mesP] = prazoConfigurado.split('/');
        const dataLimiteDesconto = new Date(document.getElementById('anoRef').value, parseInt(mesP) - 1, parseInt(diaP));
        dataLimiteDesconto.setHours(0,0,0,0);

        const mensalidadeAtual = aluno.mensalidades?.find(m => !m.pago);
        const mesExtenso = mensalidadeAtual ? nomesMesesLongos[mensalidadeAtual.mes] : "";

        if (hoje > dataLimiteDesconto) {
            return `Ol√°, ${aluno.nome}! üéì\n\nPassando para lembrar que o prazo do desconto de pontualidade para a mensalidade de ${mesExtenso} j√° expirou, mas voc√™ ainda pode realizar o pagamento pelo valor original at√© o vencimento. \n\nN√£o deixe acumular! Qualquer d√∫vida, estamos aqui. üöÄ`;
        }

        if (mensalidadeAtual && (mensalidadeAtual.mes === 1 || mensalidadeAtual.mes === 7)) {
            return `Ol√°, ${aluno.nome}! üåü\n\nN√£o esque√ßa: o pagamento do boleto de *${mesExtenso}* √© fundamental para a sua renova√ß√£o e continuidade dos estudos neste novo semestre!\n\nüí∞ *Benef√≠cio de Pontualidade:*\nPagando at√© o dia *${prazoConfigurado}*, voc√™ garante seus *9% de DESCONTO*. \n\nGaranta sua vaga e sua economia! üéìüöÄ`;
        } else {
            return `Ol√° ${aluno.nome}, üåü\n\nIdentificamos que voc√™ ainda n√£o aproveitou o seu BENEF√çCIO de Pontualidade de ${mesExtenso}! \n\nEfetue o pagamento at√© o dia *${prazoConfigurado}* e garanta automaticamente *9% de DESCONTO* no valor da parcela. \n\nAproveite para economizar! üí∞`;
        }
    }

    window.gerarTextoDoc = function(aluno) {
        const u = (aluno.unidade || "").toUpperCase();
        let contato = "(81) 99988-9803";
        let link = "https://wa.me/5581999889803";
        if (u.includes("RECIFE")) { contato = "(81) 98261-7644"; link = "https://wa.me/5581982617644"; }
        else if (u.includes("CARPINA")) { contato = "(81) 99315-7905"; link = "https://wa.me/5581993157905"; }
        return `Ol√° ${aluno.nome}! üéì\n\nIdentificamos uma pend√™ncia em sua *documenta√ß√£o acad√™mica*.\n\nEssa pend√™ncia precisa ser regularizada o quanto antes, pois ela impede a efetiva√ß√£o da sua rematr√≠cula e o seu avan√ßo para o pr√≥ximo semestre.\n\nPor favor, entre em contato com a secretaria da unidade ${aluno.unidade} para regularizar sua situa√ß√£o:\n\nüëâ *Falar com a Secretaria agora:* ${link}\n\nEstamos √† disposi√ß√£o para ajudar!`;
    }

    window.renderizarPainel = function() {
        const fUniSelect = Array.from(document.getElementById('filtroUnidade').selectedOptions).map(opt => opt.value);
        const fCat = document.getElementById('filtroCategoria').value;
        const mesRef = parseInt(document.getElementById('mesRefDash').value);
        const hoje = new Date(); hoje.setHours(0,0,0,0);
        const lista = Object.values(window.alunos).filter(a => (fUniSelect.length === 0 || fUniSelect.includes(a.unidade)) && (!fCat || a.categoria === fCat));
        let stats = { pagNoMes: 0, emAtraso: 0, env: 0 };
        lista.forEach(a => {
            const s = a.controleEnvio || 'Pendente';
            if(s === 'Enviado') stats.env++;
            const mRef = a.mensalidades.find(m => m.mes === mesRef);
            if(mRef && mRef.pago) stats.pagNoMes++;
            const temAtraso = a.mensalidades.some(m => { const dataVenc = new Date(m.vencimento + 'T00:00:00'); return !m.pago && dataVenc < hoje; });
            if(temAtraso) stats.emAtraso++;
        });
        document.getElementById('d-total').innerText = lista.length;
        document.getElementById('d-pag-mes').innerText = stats.pagNoMes;
        document.getElementById('d-atraso').innerText = stats.emAtraso;
        document.getElementById('d-env').innerText = stats.env;
    }

    window.toggleMarcador = async function(ra) {
        window.alunos[ra].marcado = !window.alunos[ra].marcado;
        await updateDoc(doc(db, "alunos", ra), { marcado: window.alunos[ra].marcado });
        renderizar();
    }

    window.toggleDoc = async function(ra) {
        const aluno = window.alunos[ra];
        aluno.docPendente = !aluno.docPendente;
        await updateDoc(doc(db, "alunos", ra), { docPendente: aluno.docPendente });
        if(aluno.docPendente) {
            const msg = gerarTextoDoc(aluno);
            window.open(`https://wa.me/55${aluno.tel}?text=${encodeURIComponent(msg)}`, '_blank');
        }
        renderizar();
    }

    window.togglePagamento = async (ra, idx) => {
        window.alunos[ra].mensalidades[idx].pago = !window.alunos[ra].mensalidades[idx].pago;
        await setDoc(doc(db, "alunos", ra), window.alunos[ra]);
        renderizar();
        renderizarPainel();
    }

    window.alterarStatus = async (ra, val) => {
        window.alunos[ra].controleEnvio = val;
        await updateDoc(doc(db, "alunos", ra), { controleEnvio: val });
        renderizar();
        renderizarPainel();
    }

    window.excluirSelecionados = async () => {
        const selecionados = document.querySelectorAll('.chk-aluno:checked');
        if (selecionados.length === 0) return alert("Selecione ao menos um aluno.");
        if (!confirm(`Deseja excluir ${selecionados.length} aluno(s)?`)) return;
        const batch = writeBatch(db);
        selecionados.forEach(chk => {
            const ra = chk.getAttribute('data-ra');
            batch.delete(doc(db, "alunos", ra));
            delete window.alunos[ra];
        });
        await batch.commit();
        renderizar();
        renderizarPainel();
    }

    window.resetarStatusEnvio = async function() {
        if(!confirm("Resetar todos os Enviados e Inv√°lidos para Pendente?")) return;
        const batch = writeBatch(db);
        Object.values(window.alunos).forEach(a => {
            if(a.controleEnvio === 'Enviado' || a.controleEnvio === 'N√∫mero Inv√°lido') {
                batch.update(doc(db, "alunos", a.ra), { controleEnvio: 'Pendente' });
                a.controleEnvio = 'Pendente';
            }
        });
        await batch.commit();
        renderizar();
    }

    window.importarCSV = function(input) { 
        const r = new FileReader(); r.onload = async (e) => { 
            const l = e.target.result.split(/\r?\n/); const batch = writeBatch(db); 
            const sem = document.getElementById('semestreSelect').value; 
            const ano = document.getElementById('anoRef').value;
            let mI = sem==="1"?1:sem==="2"?7:1; let mF = sem==="1"?6:sem==="2"?12:12;
            for (let line of l) { 
                const c = line.split(';'); if (!c[0] || c[0].toUpperCase().includes("RA")) continue; 
                const ra = c[0].replace(/\D/g, ''); if (window.alunos[ra]) continue; 
                const m = []; for(let i=mI; i<=mF; i++) m.push({mes:i, ano:ano, pago:false, vencimento:`${ano}-${String(i).padStart(2,'0')}-10`}); 
                const obj = { ra, nome: c[1]?.trim(), tel: c[2]?.replace(/\D/g,''), unidade: c[3]?.trim(), categoria: c[4]?.trim() || 'Extranet', controleEnvio: 'Pendente', mensalidades: m, marcado: false, docPendente: false };
                batch.set(doc(db, "alunos", ra), obj);
            } 
            await batch.commit(); location.reload();
        }; r.readAsText(input.files[0]); 
    };

    window.trocarTela = (id) => { 
        document.querySelectorAll('.view-container').forEach(v => v.classList.remove('view-active')); 
        document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active')); 
        document.getElementById(id).classList.add('view-active'); 
        event.currentTarget.classList.add('active'); 
    };

    window.fecharModal = () => document.getElementById('modal').style.display = 'none';
    window.toggleTodos = (el) => document.querySelectorAll('.chk-aluno').forEach(chk => chk.checked = el.checked);
    
    function atualizarOpcoesFiltros() { 
        const u = [...new Set(Object.values(window.alunos).map(a => a.unidade))].sort(); 
        document.getElementById('filtroUnidade').innerHTML = u.map(x => `<option value="${x}">${x}</option>`).join(''); 
    }
</script>
</body>
</html>
