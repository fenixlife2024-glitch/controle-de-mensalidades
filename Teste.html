<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Gest√£o Financeira Acad√™mica - Oficial</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root { --primary: #1e293b; --accent: #3b82f6; --success: #22c55e; --warning: #eab308; --danger: #ef4444; --bg: #f8fafc; --sidebar-w: 240px; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); margin: 0; padding: 0; color: #334155; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: var(--sidebar-w); background: var(--primary); color: white; display: none; flex-direction: column; z-index: 1001; }
        .sidebar-header { padding: 20px; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 14px; text-transform: uppercase; }
        .sidebar-menu { flex-grow: 1; padding: 10px 0; }
        .menu-item { padding: 12px 20px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s; font-size: 14px; }
        .menu-item:hover, .menu-item.active { background: var(--accent); color: white; }
        .view-container { flex-grow: 1; display: none; flex-direction: column; padding: 25px; overflow-y: auto; height: 100vh; box-sizing: border-box; }
        .view-active { display: flex; }
        .config-bar { background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #e2e8f0; display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 12px; align-items: flex-end; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .input-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-size: 10px; font-weight: 700; text-transform: uppercase; color: #64748b; }
        .form-control { padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 13px; outline: none; width: 100%; box-sizing: border-box; }
        .dash-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-left: 5px solid var(--accent); }
        .card h4 { margin: 0 0 10px 0; font-size: 12px; color: #64748b; text-transform: uppercase; }
        .card .val { font-size: 24px; font-weight: 800; color: var(--primary); }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; }
        th { background: #f1f5f9; color: #475569; padding: 12px; text-align: left; font-size: 11px; text-transform: uppercase; border-bottom: 2px solid #e2e8f0; position: sticky; top: 0; }
        td { padding: 10px 12px; border-bottom: 1px solid #f1f5f9; font-size: 13px; }
        tr.row-pago { background-color: #f0fdf4 !important; }
        tr.row-enviado { background-color: #fffbeb !important; }
        tr.row-invalido { background-color: #fef2f2 !important; }
        .mes-box { width: 24px; height: 24px; border-radius: 5px; border: 1px solid #cbd5e1; display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: bold; cursor: pointer; }
        .mes-pago { background: var(--success); color: white; border-color: #16a34a; }
        .mes-pendente { background: #f1f5f9; color: #94a3b8; }
        .btn { border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 11px; display: inline-flex; align-items: center; gap: 6px; transition: 0.2s; text-decoration: none; }
        .btn-zap { background: #25D366; color: white; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.7); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .modal-content { background: white; padding: 25px; border-radius: 16px; width: 95%; max-width: 550px; max-height: 90vh; overflow-y: auto; }
        #login-screen { position: fixed; inset: 0; background: var(--primary); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .star-icon { cursor: pointer; font-size: 18px; color: #cbd5e1; transition: 0.2s; }
        .star-active { color: #f59e0b !important; }
        .grid-form { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box" style="background:white; padding:40px; border-radius:16px; width:300px;">
        <h2 style="text-align:center; margin-top:0;">Login</h2>
        <input type="email" id="loginEmail" placeholder="E-mail" class="form-control" style="margin-bottom:15px;">
        <input type="password" id="loginPass" placeholder="Senha" class="form-control" style="margin-bottom:20px;">
        <button id="btnLogin" style="background:var(--accent); color:white; border:none; padding:12px; border-radius:8px; cursor:pointer; font-weight:bold; width:100%;">Entrar</button>
    </div>
</div>

<div class="sidebar" id="mainSidebar">
    <div class="sidebar-header">Fluxo de Cobran√ßa</div>
    <div class="sidebar-menu">
        <div class="menu-item active" onclick="trocarTela('mainContainer')">üìÇ Operacional</div>
        <div class="menu-item" onclick="trocarTela('painelGestao')">üìä Relat√≥rios Dire√ß√£o</div>
    </div>
    <div style="padding: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
        <label style="color: #94a3b8; margin-bottom: 5px; display: block;">Ticket M√©dio (R$)</label>
        <input type="number" id="ticketMedio" class="form-control" value="70" oninput="renderizarPainel()" style="background: #334155; color: white; border: 1px solid #475569;">
    </div>
</div>

<div class="view-container view-active" id="mainContainer">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px;">
        <h1 style="margin:0; font-size: 22px; font-weight: 800;">Painel de Cobran√ßa</h1>
        <div style="display:flex; gap:8px; align-items:center;">
            <button onclick="abrirModalCadastro()" class="btn btn-primary">‚ûï Novo Aluno</button>
            <button onclick="editarSelecionado()" class="btn btn-warning" style="background:#6366f1">‚úèÔ∏è Editar Sele√ß√£o</button>
            <button onclick="resetarStatusEnvio()" class="btn btn-warning">üîÑ Resetar Status</button>
            <button onclick="excluirSelecionados()" class="btn btn-danger">üóëÔ∏è Deletar</button>
            <span id="contador" style="font-weight:700; color:var(--accent); font-size:11px; background:#e0f2fe; padding:5px 10px; border-radius:20px;">Sincronizando...</span>
        </div>
    </div>
    
    <div class="config-bar">
        <div class="input-group">
            <label>Per√≠odo</label>
            <select id="semestreSelect" class="form-control" onchange="carregarDados()">
                <option value="all">Ano Completo</option>
                <option value="1">1¬∫ Semestre</option>
                <option value="2">2¬∫ Semestre</option>
            </select>
        </div>
        <div class="input-group"><label>Ano</label><input type="number" id="anoRef" class="form-control" value="2026"></div>
        <div class="input-group"><label>Unidade</label><select id="filtroUnidade" class="form-control" onchange="renderizar(); renderizarPainel();"><option value="">Todas</option></select></div>
        
        <div class="input-group">
            <label>Status</label>
            <select id="filtroStatusEnvio" class="form-control" onchange="renderizar()">
                <option value="todos">Todos</option>
                <option value="Pendente">‚è≥ Pendentes</option>
                <option value="Enviado">üì§ Enviados</option>
                <option value="Pago">‚úÖ Pagos</option>
                <option value="N√∫mero Inv√°lido">üö´ Inv√°lidos</option>
            </select>
        </div>

        <div class="input-group">
            <label>Marcador ‚òÖ</label>
            <select id="filtroMarcado" class="form-control" onchange="renderizar()">
                <option value="todos">Todos</option>
                <option value="marcados">Estrela ‚òÖ</option>
            </select>
        </div>
        <div class="input-group"><label>Categoria</label><select id="filtroCategoria" class="form-control" onchange="renderizar(); renderizarPainel();"><option value="">Todas</option><option value="PTC">PTC</option><option value="Extranet">Extranet</option></select></div>
        <div class="input-group"><label>Prazo 9% Off</label><input type="text" id="prazoCampanha" class="form-control" value="05/02" oninput="renderizar()"></div>
        <div class="input-group"><label style="color:var(--accent)">Importar CSV</label><input type="file" id="csvInput" accept=".csv" class="form-control" onchange="importarCSV(this)"></div>
    </div>

    <input type="text" id="busca" placeholder="Pesquisar por nome ou RA..." class="form-control" style="width:100%; margin-bottom:15px; padding:12px;" onkeyup="renderizar()">
    
    <div style="flex-grow:1; overflow:auto; background:white; border-radius:12px; border:1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);">
        <table>
            <thead><tr><th style="width:20px;"><input type="checkbox" onclick="toggleTodos(this)"></th><th style="width:30px;">‚òÖ</th><th>RA</th><th>Nome do Aluno</th><th>Meses</th><th>Status</th><th>WhatsApp</th><th>Lembrete</th></tr></thead>
            <tbody id="corpoTabela"></tbody>
        </table>
    </div>
</div>

<div id="modal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 id="modalTitle" style="margin:0; font-size:18px;">Dados do Aluno</h3>
            <button onclick="fecharModal()" style="border:none; background:none; cursor:pointer; font-size:28px; color:#94a3b8;">&times;</button>
        </div>
        
        <div class="grid-form">
            <div class="input-group"><label>RA (√önico)</label><input type="text" id="mRA" class="form-control"></div>
            <div class="input-group"><label>Nome Completo</label><input type="text" id="mNome" class="form-control"></div>
            <div class="input-group"><label>WhatsApp (DDD+N√∫mero)</label><input type="text" id="mTel" class="form-control"></div>
            <div class="input-group"><label>Unidade</label><input type="text" id="mUnidade" class="form-control"></div>
            <div class="input-group"><label>Categoria</label><select id="mCategoria" class="form-control"><option value="Extranet">Extranet</option><option value="PTC">PTC</option></select></div>
            <div class="input-group"><label>Status de Envio</label><select id="mStatusEnvio" class="form-control"><option value="Pendente">Pendente</option><option value="Enviado">Enviado</option><option value="Pago">Pago</option><option value="N√∫mero Inv√°lido">Inv√°lido</option></select></div>
        </div>

        <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">
        <label style="margin-bottom:10px; display:block; font-weight:bold;">Vencimentos das Mensalidades:</label>
        <div id="listaMensalidades" style="display:flex; flex-direction:column; gap:8px; margin-bottom:20px;"></div>

        <button onclick="salvarAluno()" class="btn btn-primary" style="width:100%; padding:12px; justify-content:center; font-size:14px;">üíæ Salvar Informa√ß√µes</button>
    </div>
</div>

<div class="view-container" id="painelGestao">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 25px;">
        <h1 style="margin:0; font-size: 22px; font-weight: 800;">Relat√≥rios Executivos</h1>
        <div style="display:flex; gap:10px; align-items:flex-end;">
            <div class="input-group">
                <label>M√™s Ref.</label>
                <select id="mesRefDash" class="form-control" onchange="renderizarPainel()"></select>
            </div>
            <button onclick="gerarRelatorioPDF()" class="btn btn-primary" style="padding:12px 25px;">üìÑ PDF Diretoria</button>
        </div>
    </div>
    <div class="dash-grid">
        <div class="card"><h4>Total Clientes</h4><span class="val" id="d-total">0</span></div>
        <div class="card" style="border-left-color: var(--success)"><h4>Pagos (M√™s)</h4><span class="val" id="d-pag-mes">0</span></div>
        <div class="card" style="border-left-color: var(--danger)"><h4>Em Atraso</h4><span class="val" id="d-atraso">0</span></div>
        <div class="card" style="border-left-color: var(--warning)"><h4>Enviados</h4><span class="val" id="d-env">0</span></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDocs, collection, updateDoc, writeBatch, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = { apiKey: "AIzaSyC4_dlIiCaNHtj7eWB4kW200vnO6AuuuTA", authDomain: "reguacobranca.firebaseapp.com", projectId: "reguacobranca", storageBucket: "reguacobranca.firebasestorage.app", messagingSenderId: "85201788796", appId: "1:85201788796:web:25cf11a726cec89d248ef9" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    window.alunos = {};
    const nomesMesesLongos = ["", "JANEIRO", "FEVEREIRO", "MAR√áO", "ABRIL", "MAIO", "JUNHO", "JULHO", "AGOSTO", "SETEMBRO", "OUTUBRO", "NOVEMBRO", "DEZEMBRO"];

    onAuthStateChanged(auth, user => { if (user) { document.getElementById('login-screen').style.display='none'; document.getElementById('mainSidebar').style.display='flex'; document.getElementById('mainContainer').style.display='flex'; carregarDados(); } });
    document.getElementById('btnLogin').addEventListener('click', async () => { try { await signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPass').value); } catch(e) { alert("Acesso Negado"); } });

    async function carregarDados() {
        const snap = await getDocs(collection(db, "alunos"));
        window.alunos = {};
        snap.forEach(doc => { window.alunos[doc.id] = doc.data(); });
        atualizarOpcoesFiltros();
        atualizarMesesReferencia();
        renderizar();
        renderizarPainel();
    }

    function atualizarMesesReferencia() {
        const sem = document.getElementById('semestreSelect').value;
        const select = document.getElementById('mesRefDash');
        let mI = 1, mF = 12;
        if(sem === "1") { mI = 1; mF = 6; }
        else if(sem === "2") { mI = 7; mF = 12; }
        select.innerHTML = '';
        for(let i=mI; i<=mF; i++) {
            const opt = document.createElement('option');
            opt.value = i;
            opt.innerText = nomesMesesLongos[i];
            if(new Date().getMonth()+1 === i) opt.selected = true;
            select.appendChild(opt);
        }
    }

    // MODAL DE CADASTRO/EDI√á√ÉO
    window.abrirModalCadastro = function() {
        document.getElementById('modalTitle').innerText = "Cadastrar Novo Aluno";
        document.getElementById('mRA').value = "";
        document.getElementById('mRA').disabled = false;
        document.getElementById('mNome').value = "";
        document.getElementById('mTel').value = "";
        document.getElementById('mUnidade').value = "";
        document.getElementById('mCategoria').value = "Extranet";
        document.getElementById('mStatusEnvio').value = "Pendente";
        
        // Gerar estrutura de mensalidades baseada no filtro atual
        const sem = document.getElementById('semestreSelect').value;
        const ano = document.getElementById('anoRef').value;
        let mI = sem==="1"?1:sem==="2"?7:1; 
        let mF = sem==="1"?6:sem==="2"?12:12;
        
        const lista = document.getElementById('listaMensalidades');
        lista.innerHTML = '';
        for(let i=mI; i<=mF; i++) {
            renderizarLinhaMensalidade({mes: i, vencimento: `${ano}-${String(i).padStart(2,'0')}-10`, pago: false}, i-mI);
        }
        document.getElementById('modal').style.display = 'flex';
    }

    window.editarSelecionado = function() {
        const selecionados = document.querySelectorAll('.chk-aluno:checked');
        if(selecionados.length !== 1) return alert("Selecione exatamente 1 aluno para editar.");
        const ra = selecionados[0].getAttribute('data-ra');
        abrirModalEdicao(ra);
    }

    window.abrirModalEdicao = function(ra) {
        const aluno = window.alunos[ra];
        document.getElementById('modalTitle').innerText = "Editando: " + aluno.nome;
        document.getElementById('mRA').value = aluno.ra;
        document.getElementById('mRA').disabled = true; // RA n√£o se muda
        document.getElementById('mNome').value = aluno.nome;
        document.getElementById('mTel').value = aluno.tel;
        document.getElementById('mUnidade').value = aluno.unidade;
        document.getElementById('mCategoria').value = aluno.categoria || "Extranet";
        document.getElementById('mStatusEnvio').value = aluno.controleEnvio || "Pendente";
        
        const lista = document.getElementById('listaMensalidades');
        lista.innerHTML = '';
        aluno.mensalidades.forEach((m, idx) => {
            renderizarLinhaMensalidade(m, idx);
        });
        document.getElementById('modal').style.display = 'flex';
    }

    function renderizarLinhaMensalidade(m, idx) {
        const div = document.createElement('div');
        div.style = 'display:flex; justify-content:space-between; align-items:center; padding:5px; border-bottom:1px solid #f1f5f9; gap:10px;';
        div.innerHTML = `
            <span style="font-size:12px; font-weight:600; width:60px;">M√™s ${m.mes}</span>
            <input type="date" value="${m.vencimento}" class="form-control m-venc" data-mes="${m.mes}" style="width:140px;">
            <label style="font-size:9px; display:flex; align-items:center; gap:4px;">
                <input type="checkbox" class="m-pago" ${m.pago?'checked':''}> Pago
            </label>
        `;
        document.getElementById('listaMensalidades').appendChild(div);
    }

    window.salvarAluno = async function() {
        const ra = document.getElementById('mRA').value.replace(/\D/g, '');
        if(!ra) return alert("RA √© obrigat√≥rio");

        const mensalidades = [];
        document.querySelectorAll('#listaMensalidades > div').forEach(div => {
            mensalidades.push({
                mes: parseInt(div.querySelector('.m-venc').getAttribute('data-mes')),
                vencimento: div.querySelector('.m-venc').value,
                pago: div.querySelector('.m-pago').checked,
                ano: document.getElementById('anoRef').value
            });
        });

        const dados = {
            ra: ra,
            nome: document.getElementById('mNome').value.trim(),
            tel: document.getElementById('mTel').value.replace(/\D/g, ''),
            unidade: document.getElementById('mUnidade').value.trim(),
            categoria: document.getElementById('mCategoria').value,
            controleEnvio: document.getElementById('mStatusEnvio').value,
            marcado: window.alunos[ra]?.marcado || false,
            mensalidades: mensalidades
        };

        try {
            await setDoc(doc(db, "alunos", ra), dados);
            window.alunos[ra] = dados;
            fecharModal();
            renderizar();
            renderizarPainel();
            atualizarOpcoesFiltros();
            alert("Dados salvos com sucesso!");
        } catch (e) {
            alert("Erro ao salvar: " + e.message);
        }
    }

    // FUN√á√ïES DE RENDERIZA√á√ÉO E OPERACIONAIS
    window.renderizar = function() {
        const t = document.getElementById('corpoTabela');
        const b = document.getElementById('busca').value.toLowerCase();
        const fUni = document.getElementById('filtroUnidade').value;
        const fCat = document.getElementById('filtroCategoria').value;
        const fMarcado = document.getElementById('filtroMarcado').value;
        const fStatus = document.getElementById('filtroStatusEnvio').value;
        
        const lista = Object.values(window.alunos).filter(a => {
            const status = a.controleEnvio || 'Pendente';
            const matchFiltros = (!fUni || a.unidade === fUni) && (!fCat || a.categoria === fCat);
            const matchBusca = (a.nome?.toLowerCase().includes(b) || a.ra.includes(b));
            const matchMarcado = (fMarcado === 'todos' || (fMarcado === 'marcados' && a.marcado));
            const matchStatusEnvio = (fStatus === 'todos' || status === fStatus);
            return matchFiltros && matchBusca && matchMarcado && matchStatusEnvio;
        }).sort((x,y) => x.nome.localeCompare(y.nome));

        t.innerHTML = '';
        lista.forEach(a => {
            const status = a.controleEnvio || 'Pendente';
            const tr = document.createElement('tr');
            tr.className = status==='Pago'?'row-pago':status==='Enviado'?'row-enviado':status==='N√∫mero Inv√°lido'?'row-invalido':'';
            tr.innerHTML = `
                <td><input type="checkbox" class="chk-aluno" data-ra="${a.ra}"></td>
                <td><span class="star-icon ${a.marcado ? 'star-active' : ''}" onclick="toggleMarcador('${a.ra}')">‚òÖ</span></td>
                <td>${a.ra}</td>
                <td onclick="abrirModalEdicao('${a.ra}')" style="cursor:pointer; color:var(--accent); font-weight:700;">${a.nome}</td>
                <td><div style="display:flex; gap:4px; flex-wrap:wrap; max-width:200px;">${a.mensalidades.map((m,i)=>`<div class="mes-box ${m.pago?'mes-pago':'mes-pendente'}" onclick="togglePagamento('${a.ra}',${i})">${m.mes}</div>`).join('')}</div></td>
                <td>
                    <select class="form-control" onchange="alterarStatus('${a.ra}', this.value)" style="font-size:10px; height:28px; padding:2px;">
                        <option value="Pendente" ${status==='Pendente'?'selected':''}>‚è≥ Pendente</option>
                        <option value="Enviado" ${status==='Enviado'?'selected':''}>üì§ Enviado</option>
                        <option value="Pago" ${status==='Pago'?'selected':''}>‚úÖ Pago</option>
                        <option value="N√∫mero Inv√°lido" ${status==='N√∫mero Inv√°lido'?'selected':''}>üö´ Inv√°lido</option>
                    </select>
                </td>
                <td><a class="btn btn-zap" href="https://wa.me/55${a.tel}?text=${encodeURIComponent(gerarTextoZap(a))}" target="_blank" onclick="alterarStatus('${a.ra}', 'Enviado')">üì± Enviar</a></td>
                <td><a class="btn" style="background:#8b5cf6; color:white;" href="https://wa.me/55${a.tel}?text=${encodeURIComponent(gerarTexto9Off(a))}" target="_blank">üíé 9% Off</a></td>`;
            t.appendChild(tr);
        });
        document.getElementById('contador').innerText = `${lista.length} Clientes`;
    }

    // L√ìGICA DE TEXTOS ZAP
    function gerarTextoZap(aluno) {
        const hoje = new Date(); hoje.setHours(0,0,0,0);
        const mensalidade = aluno.mensalidades?.find(m => !m.pago);
        if (!mensalidade) return `Ol√° ${aluno.nome}, identificamos que voc√™ est√° em dia com suas mensalidades!`;
        const dataVenc = new Date(mensalidade.vencimento + 'T00:00:00');
        const mesExtenso = nomesMesesLongos[mensalidade.mes];
        const anoRef = document.getElementById('anoRef').value;
        if (hoje > dataVenc) {
            const diffDays = Math.ceil(Math.abs(hoje - dataVenc) / (1000 * 60 * 60 * 24));
            return `Ol√° ${aluno.nome}, tudo bem? Notamos que a sua mensalidade de ${mesExtenso} est√° em atraso h√° ${diffDays} dias. Precisamos regularizar sua situa√ß√£o no portal para evitar suspens√£o de servi√ßos. Caso j√° tenha pago, desconsidere esta mensagem.`;
        }
        if (mensalidade.mes === 1 || mensalidade.mes === 7) {
            const sem = mensalidade.mes === 1 ? '1' : '2';
            return `üöÄ Ol√° ${aluno.nome}, N√£o Pare de Evoluir!\n\nSua pr√≥xima conquista est√° esperando! A rematr√≠cula ${anoRef}.${sem} j√° est√° liberada.\n\nüëâ Pague o Boleto de ${mesExtenso} anexo e automaticamente ative sua vaga!\n\nN√£o deixe para a √∫ltima hora. Vamos juntos para ${anoRef}! üöÄ`;
        }
        return `Ol√° ${aluno.nome}, tudo bem? \n\nüöÄPassando para informar que o boleto de ${mesExtenso} est√° dispon√≠vel em sua plataforma. \n\nüëâSiga as orienta√ß√µes: \nüëâClique no √≠tem financeiro; \nüëâMensalidades e servi√ßos; \nüëâSelecione Pagar; Escolha Boleto, Pix ou Cart√£o. \n\nüëâD√∫vidas? Tutorial: https://www.youtube.com/watch?v=vcaDMgU-yg0`;
    }

    function gerarTexto9Off(aluno) {
        const prazo = document.getElementById('prazoCampanha').value;
        return `Ol√° ${aluno.nome}, üåü\n\nIdentificamos que voc√™ ainda n√£o aproveitou o seu BENEF√çCIO de Pontualidade! \n\nEfetue o pagamento da sua mensalidade at√© o dia *${prazo}* e garanta automaticamente *9% de DESCONTO* no valor da parcela. \n\nAproveite para economizar! Qualquer d√∫vida, estamos √† disposi√ß√£o.`;
    }

    // UTILIT√ÅRIOS
    window.renderizarPainel = function() {
        const ticket = parseFloat(document.getElementById('ticketMedio').value) || 70;
        const fUni = document.getElementById('filtroUnidade').value;
        const fCat = document.getElementById('filtroCategoria').value;
        const mesRef = parseInt(document.getElementById('mesRefDash').value);
        const hoje = new Date(); hoje.setHours(0,0,0,0);
        const lista = Object.values(window.alunos).filter(a => (!fUni || a.unidade === fUni) && (!fCat || a.categoria === fCat));
        let stats = { pagNoMes: 0, emAtraso: 0, env: 0 };
        lista.forEach(a => {
            const s = a.controleEnvio || 'Pendente';
            if(s === 'Enviado') stats.env++;
            const mRef = a.mensalidades.find(m => m.mes === mesRef);
            if(mRef && mRef.pago) stats.pagNoMes++;
            const temAtraso = a.mensalidades.some(m => { const dataVenc = new Date(m.vencimento + 'T00:00:00'); return !m.pago && dataVenc < hoje; });
            if(temAtraso) stats.emAtraso++;
        });
        document.getElementById('d-total').innerText = lista.length;
        document.getElementById('d-pag-mes').innerText = stats.pagNoMes;
        document.getElementById('d-atraso').innerText = stats.emAtraso;
        document.getElementById('d-env').innerText = stats.env;
    }

    window.toggleMarcador = async function(ra) {
        window.alunos[ra].marcado = !window.alunos[ra].marcado;
        await updateDoc(doc(db, "alunos", ra), { marcado: window.alunos[ra].marcado });
        renderizar();
    }

    window.togglePagamento = async (ra, idx) => {
        window.alunos[ra].mensalidades[idx].pago = !window.alunos[ra].mensalidades[idx].pago;
        await setDoc(doc(db, "alunos", ra), window.alunos[ra]);
        renderizar();
        renderizarPainel();
    }

    window.alterarStatus = async (ra, val) => {
        window.alunos[ra].controleEnvio = val;
        await updateDoc(doc(db, "alunos", ra), { controleEnvio: val });
        renderizar();
        renderizarPainel();
    }

    window.excluirSelecionados = async () => {
        const selecionados = document.querySelectorAll('.chk-aluno:checked');
        if (selecionados.length === 0) return alert("Selecione ao menos um aluno.");
        if (!confirm(`Deseja excluir ${selecionados.length} aluno(s)?`)) return;
        
        const batch = writeBatch(db);
        selecionados.forEach(chk => {
            const ra = chk.getAttribute('data-ra');
            batch.delete(doc(db, "alunos", ra));
            delete window.alunos[ra];
        });
        await batch.commit();
        renderizar();
        renderizarPainel();
    }

    window.resetarStatusEnvio = async function() {
        if(!confirm("Resetar todos os Enviados e Inv√°lidos para Pendente?")) return;
        const batch = writeBatch(db);
        Object.values(window.alunos).forEach(a => {
            if(a.controleEnvio === 'Enviado' || a.controleEnvio === 'N√∫mero Inv√°lido') {
                batch.update(doc(db, "alunos", a.ra), { controleEnvio: 'Pendente' });
                a.controleEnvio = 'Pendente';
            }
        });
        await batch.commit();
        renderizar();
    }

    window.importarCSV = function(input) { 
        const r = new FileReader(); r.onload = async (e) => { 
            const l = e.target.result.split(/\r?\n/); const batch = writeBatch(db); 
            const sem = document.getElementById('semestreSelect').value; 
            const ano = document.getElementById('anoRef').value;
            let mI = sem==="1"?1:sem==="2"?7:1; let mF = sem==="1"?6:sem==="2"?12:12;
            for (let line of l) { 
                const c = line.split(';'); if (!c[0] || c[0].toUpperCase().includes("RA")) continue; 
                const ra = c[0].replace(/\D/g, ''); if (window.alunos[ra]) continue; 
                const m = []; for(let i=mI; i<=mF; i++) m.push({mes:i, ano:ano, pago:false, vencimento:`${ano}-${String(i).padStart(2,'0')}-10`}); 
                const obj = { ra, nome: c[1]?.trim(), tel: c[2]?.replace(/\D/g,''), unidade: c[3]?.trim(), categoria: c[4]?.trim() || 'Extranet', controleEnvio: 'Pendente', mensalidades: m, marcado: false };
                batch.set(doc(db, "alunos", ra), obj);
            } 
            await batch.commit(); location.reload();
        }; r.readAsText(input.files[0]); 
    };

    window.trocarTela = (id) => { 
        document.querySelectorAll('.view-container').forEach(v => v.classList.remove('view-active')); 
        document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active')); 
        document.getElementById(id).classList.add('view-active'); 
        event.currentTarget.classList.add('active'); 
    };

    window.fecharModal = () => document.getElementById('modal').style.display = 'none';
    window.toggleTodos = (el) => document.querySelectorAll('.chk-aluno').forEach(chk => chk.checked = el.checked);
    function atualizarOpcoesFiltros() { 
        const u = [...new Set(Object.values(window.alunos).map(a => a.unidade))].sort(); 
        document.getElementById('filtroUnidade').innerHTML = '<option value="">Todas</option>' + u.map(x => `<option value="${x}">${x}</option>`).join(''); 
    }
</script>
</body>
</html>
