<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Cobran√ßa Pro - Firebase Oficial</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #0f172a; color: #f8fafc; }
        .bg-dark-blue { background-color: #1e293b; }
        .text-orange { color: #f97316; }
        .bg-orange { background-color: #f97316; }
        .bg-orange:hover { background-color: #ea580c; }
        #login-screen { position: fixed; inset: 0; background: #0f172a; display: flex; justify-content: center; align-items: center; z-index: 2000; }
    </style>
</head>
<body class="font-sans">

    <div id="login-screen">
        <div class="bg-white p-8 rounded-xl w-80 text-slate-900 shadow-2xl text-center">
            <h2 class="font-bold text-xl mb-4 text-orange italic">SISTEMA COBRAN√áA</h2>
            <input type="email" id="loginEmail" placeholder="E-mail" class="w-full p-2 border rounded mb-3 outline-none">
            <input type="password" id="loginPass" placeholder="Senha" class="w-full p-2 border rounded mb-4 outline-none">
            <button id="btnLogin" class="w-full bg-orange text-white font-bold py-2 rounded uppercase">Acessar Banco</button>
        </div>
    </div>

    <div id="app-content" class="flex min-h-screen" style="display:none;">
        <aside class="w-64 bg-dark-blue p-6 border-r border-gray-700 hidden md:block">
            <h1 class="text-2xl font-bold text-orange mb-8 text-center italic">SISTEMA <span class="text-white">COBRAN√áA</span></h1>
            <nav class="space-y-4">
                <button onclick="renderizarTabela()" class="w-full text-left p-3 rounded bg-orange text-white font-bold shadow-lg shadow-orange/20"><i class="fas fa-home mr-2"></i> Dashboard</button>
                <button onclick="openModal('modalAluno')" class="w-full text-left p-3 rounded hover:bg-slate-700 transition"><i class="fas fa-plus mr-2"></i> Novo Aluno</button>
            </nav>
            <div class="mt-10">
                <label class="text-xs uppercase text-gray-500 font-black">Filtrar Unidade</label>
                <select id="filtroUnidade" onchange="renderizarTabela()" class="w-full mt-2 bg-slate-800 border border-gray-600 p-2 rounded text-sm outline-none">
                    <option value="Todas">Todas as Unidades</option>
                    <option value="Recife">Recife</option>
                    <option value="Carpina">Carpina</option>
                    <option value="Gravat√°">Gravat√°</option>
                    <option value="Bezerros">Bezerros</option>
                    <option value="Amaraji">Amaraji</option>
                </select>
            </div>
        </aside>

        <main class="flex-1 p-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                <div class="bg-dark-blue p-5 rounded-lg border-b-4 border-orange text-center">
                    <p class="text-gray-400 text-xs uppercase font-bold">Acordos Fechados</p>
                    <h3 id="cardFechados" class="text-3xl font-black text-orange">0</h3>
                </div>
                <div class="bg-dark-blue p-5 rounded-lg border-b-4 border-blue-500 text-center">
                    <p class="text-gray-400 text-xs uppercase font-bold">Propostas Enviadas</p>
                    <h3 id="cardEnviados" class="text-3xl font-black text-blue-400">0</h3>
                </div>
            </div>

            <div class="bg-dark-blue rounded shadow-2xl overflow-hidden border border-gray-800">
                <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-slate-800/30">
                    <h2 class="font-bold text-lg">Negocia√ß√µes em Aberto</h2>
                    <input type="text" id="buscaGeral" onkeyup="renderizarTabela()" placeholder="Buscar nome ou CPF..." class="bg-slate-900 border border-gray-700 p-2 rounded text-sm w-72 outline-none">
                </div>
                <table class="w-full text-left">
                    <thead class="bg-slate-800 text-xs uppercase text-gray-400 font-black">
                        <tr>
                            <th class="p-4">Aluno / CPF</th>
                            <th class="p-4">Unidade</th>
                            <th class="p-4">Status</th>
                            <th class="p-4">Vencimento</th>
                            <th class="p-4 text-center">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="listaAlunos" class="divide-y divide-gray-800"></tbody>
                </table>
            </div>
        </main>
    </div>

    <div id="modalAluno" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-dark-blue w-full max-w-md p-6 rounded-lg border border-gray-700">
            <h2 class="text-xl font-bold text-orange mb-4">Novo Aluno</h2>
            <form id="formAluno" class="space-y-4">
                <input type="text" id="nome" placeholder="Nome do Aluno" required class="w-full bg-slate-900 border border-gray-700 p-2 rounded uppercase outline-none">
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="cpf" placeholder="CPF: 000.000.000-00" oninput="maskCPF(this)" maxlength="14" required class="w-full bg-slate-900 border border-gray-700 p-2 rounded outline-none">
                    <input type="text" id="tel" placeholder="WhatsApp" oninput="maskTel(this)" maxlength="15" required class="w-full bg-slate-900 border border-gray-700 p-2 rounded outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <select id="unidade" class="w-full bg-slate-900 border border-gray-700 p-2 rounded outline-none">
                        <option value="Recife">Recife</option>
                        <option value="Carpina">Carpina</option>
                        <option value="Gravat√°">Gravat√°</option>
                        <option value="Bezerros">Bezerros</option>
                        <option value="Amaraji">Amaraji</option>
                    </select>
                    <select id="tipo" class="w-full bg-slate-900 border border-gray-700 p-2 rounded outline-none">
                        <option value="Extranet">Extranet</option>
                        <option value="PTC">PTC</option>
                    </select>
                </div>
                <div class="flex justify-end gap-3 pt-4 border-t border-gray-800">
                    <button type="button" onclick="closeModal('modalAluno')" class="text-gray-400 font-bold">Cancelar</button>
                    <button type="submit" class="bg-orange px-6 py-2 rounded font-black text-white uppercase text-sm">Salvar Aluno</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalAcordo" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-dark-blue w-full max-w-md p-6 rounded-lg border-2 border-orange">
            <h2 class="text-xl font-bold text-orange mb-1">Gerar Acordo</h2>
            <p id="nomeAlunoAcordo" class="text-xs text-gray-400 mb-6"></p>
            <div class="space-y-4">
                <input type="text" id="valorAVista" onkeyup="maskDinheiro(this)" placeholder="Valor √Ä Vista R$ 0,00" class="w-full bg-slate-900 border border-gray-700 p-2 rounded text-orange font-bold outline-none">
                <input type="text" id="valorAcordo" onkeyup="maskDinheiro(this)" placeholder="Valor Total Boleto R$ 0,00" class="w-full bg-slate-900 border border-gray-700 p-2 rounded font-bold outline-none">
                <div class="grid grid-cols-3 gap-2">
                    <input type="text" id="entrada" onkeyup="maskDinheiro(this)" placeholder="Entrada" class="w-full bg-slate-900 border border-gray-700 p-2 rounded outline-none">
                    <input type="number" id="numParcelas" value="1" class="w-full bg-slate-900 border border-gray-700 p-2 rounded outline-none">
                    <input type="text" id="vlrParcelaManual" onkeyup="maskDinheiro(this)" placeholder="Vlr Parcela" class="w-full bg-slate-900 border border-gray-700 p-2 rounded outline-none text-orange font-bold">
                </div>
                <div class="flex items-center gap-2 bg-slate-800 p-3 rounded">
                    <input type="checkbox" id="checkRematricula" class="w-5 h-5 accent-orange">
                    <label for="checkRematricula" class="text-sm font-bold">Incluir Rematr√≠cula (Emocional)</label>
                </div>
                <div class="flex justify-between gap-3 pt-4">
                    <button type="button" onclick="closeModal('modalAcordo')" class="text-gray-400 font-bold">Cancelar</button>
                    <button onclick="gerarEnviar()" class="bg-orange px-8 py-3 rounded font-black text-white uppercase text-xs">Gerar e Enviar Zap</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyC4_dlIiCaNHtj7eWB4kW200vnO6AuuuTA", 
            authDomain: "reguacobranca.firebaseapp.com", 
            projectId: "reguacobranca", 
            storageBucket: "reguacobranca.firebasestorage.app", 
            messagingSenderId: "85201788796", 
            appId: "1:85201788796:web:25cf11a726cec89d248ef9" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const colRef = collection(db, "negociacoes");

        window.db_local = [];
        window.idxAtivo = null;

        // M√°scaras
        window.maskCPF = (i) => {
            let v = i.value.replace(/\D/g, "");
            v = v.replace(/(\d{3})(\d)/, "$1.$2");
            v = v.replace(/(\d{3})(\d)/, "$1.$2");
            v = v.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
            i.value = v;
        };

        window.maskTel = (i) => {
            let v = i.value.replace(/\D/g, "");
            v = v.replace(/^(\d{2})(\d)/g, "($1) $2");
            v = v.replace(/(\d)(\d{4})$/, "$1-$2");
            i.value = v;
        };

        window.maskDinheiro = (i) => {
            let v = i.value.replace(/\D/g,'');
            v = (v/100).toFixed(2) + '';
            v = v.replace(".", ",");
            v = v.replace(/(\d)(\d{3})(\d{3}),/g, "$1.$2.$3,");
            v = v.replace(/(\d)(\d{3}),/g, "$1.$2,");
            i.value = "R$ " + v;
        };

        // Firebase Logic
        onAuthStateChanged(auth, user => {
            if (user) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-content').style.display = 'flex';
                ouvirBanco();
            }
        });

        document.getElementById('btnLogin').addEventListener('click', async () => {
            try { await signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPass').value); } 
            catch(e) { alert("Acesso inv√°lido."); }
        });

        function ouvirBanco() {
            onSnapshot(colRef, (snapshot) => {
                window.db_local = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderizarTabela();
            });
        }

        window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.closeModal = (id) => { document.getElementById(id).classList.add('hidden'); window.idxAtivo = null; };

        document.getElementById('formAluno').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('cpf').value.replace(/\D/g, '');
            const novo = {
                nome: document.getElementById('nome').value.toUpperCase(),
                cpf: document.getElementById('cpf').value,
                tel: document.getElementById('tel').value,
                tipo: document.getElementById('tipo').value,
                unidade: document.getElementById('unidade').value,
                status: 'Pendente'
            };
            await setDoc(doc(db, "negociacoes", id), novo);
            closeModal('modalAluno');
            e.target.reset();
        });

        window.prepararAcordo = (idx) => {
            window.idxAtivo = idx;
            document.getElementById('nomeAlunoAcordo').innerText = "Aluno: " + window.db_local[idx].nome;
            openModal('modalAcordo');
        };

        window.gerarEnviar = async () => {
            const a = window.db_local[window.idxAtivo];
            const vAV = document.getElementById('valorAVista').value;
            const vAC = document.getElementById('valorAcordo').value;
            const ent = document.getElementById('entrada').value;
            const parc = document.getElementById('numParcelas').value;
            const vPM = document.getElementById('vlrParcelaManual').value;
            const remat = document.getElementById('checkRematricula').checked;

            const dt = new Date(); dt.setDate(dt.getDate() + 4);
            const venc = dt.toLocaleDateString('pt-BR');

            const baseTexto = `‚úÖ *√Ä VISTA/CART√ÉO:* ${vAV} (em at√© 12x iguais).\nüì¶ *PARCELADO NO BOLETO:* Total de ${vAC} sendo Entrada de ${ent} + ${parc} parcelas de ${vPM}.\n\n*Vencimento:* ${venc}.`;

            let msg = remat ? 
                `Ol√°, *${a.nome}*! Sentimos sua falta na unidade *${a.unidade}*. Seu sonho n√£o pode parar. Preparamos uma condi√ß√£o exclusiva:\n\nüöÄ ${baseTexto}\n\nCom a rematr√≠cula, sua plataforma volta em at√© 7 dias √∫teis. Vamos recome√ßar? Responda *SIM*.` :
                `Ol√°, *${a.nome}*. Temos uma proposta para regularizar suas pend√™ncias na unidade *${a.unidade}*:\n\n${baseTexto}\n\nBaixa nos sistemas em at√© 5 dias √∫teis. Responda *SIM* para fechar o acordo.`;

            await updateDoc(doc(db, "negociacoes", a.id), { status: 'Enviado', fin: {venc} });
            closeModal('modalAcordo');
            window.open(`https://api.whatsapp.com/send?phone=55${a.tel.replace(/\D/g,'')}&text=${encodeURIComponent(msg)}`);
        };

        window.confirmar = async (idx) => {
            if(confirm("Confirmar fechamento?")) await updateDoc(doc(db, "negociacoes", window.db_local[idx].id), { status: 'Confirmado' });
        };

        window.excluirAluno = async (idx) => {
            if(confirm("Excluir?")) await deleteDoc(doc(db, "negociacoes", window.db_local[idx].id));
        };

        window.renderizarTabela = () => {
            const lista = document.getElementById('listaAlunos');
            const filtroU = document.getElementById('filtroUnidade').value;
            const busca = document.getElementById('buscaGeral').value.toLowerCase();
            lista.innerHTML = "";
            let f=0, e=0;

            window.db_local.forEach((a, idx) => {
                if(filtroU !== "Todas" && a.unidade !== filtroU) return;
                if(busca && !a.nome.toLowerCase().includes(busca)) return;
                if(a.status === 'Confirmado') f++;
                if(a.status === 'Enviado') e++;

                lista.innerHTML += `
                    <tr class="hover:bg-slate-800 transition border-b border-gray-800 text-sm">
                        <td class="p-4"><b>${a.nome}</b><br><span class="text-[10px] text-gray-500">${a.cpf}</span></td>
                        <td class="p-4">${a.unidade}</td>
                        <td class="p-4">${a.status}</td>
                        <td class="p-4">${a.fin ? a.fin.venc : '---'}</td>
                        <td class="p-4 flex gap-4">
                            <button onclick="prepararAcordo(${idx})" class="text-orange"><i class="fas fa-handshake"></i></button>
                            <button onclick="confirmar(${idx})" class="text-green-500"><i class="fas fa-check-double"></i></button>
                            <button onclick="excluirAluno(${idx})" class="text-red-900"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
            });
            document.getElementById('cardFechados').innerText = f;
            document.getElementById('cardEnviados').innerText = e;
        };
    </script>
</body>
</html>
