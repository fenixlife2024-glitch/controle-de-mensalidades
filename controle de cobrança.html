<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Cobran√ßa Pro - Marketing & CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #0f172a; color: #f8fafc; }
        .bg-dark-blue { background-color: #1e293b; }
        .text-orange { color: #f97316; }
        .bg-orange { background-color: #f97316; }
        #login-screen { position: fixed; inset: 0; background: #0f172a; display: flex; justify-content: center; align-items: center; z-index: 2000; }
    </style>
</head>
<body class="font-sans">

    <div id="login-screen">
        <div class="bg-white p-8 rounded-xl w-80 text-slate-900 shadow-2xl text-center">
            <h2 class="font-bold text-xl mb-4 text-orange italic">SISTEMA COBRAN√áA</h2>
            <input type="email" id="loginEmail" placeholder="E-mail" class="w-full p-2 border rounded mb-3 outline-none focus:border-orange">
            <input type="password" id="loginPass" placeholder="Senha" class="w-full p-2 border rounded mb-4 outline-none focus:border-orange">
            <button id="btnLogin" class="w-full bg-orange text-white font-bold py-2 rounded uppercase italic">Acessar</button>
        </div>
    </div>

    <div id="app-content" class="flex min-h-screen" style="display:none;">
        <aside class="w-64 bg-dark-blue p-6 border-r border-gray-700 hidden md:block">
            <h1 class="text-2xl font-bold text-orange mb-8 text-center italic">SISTEMA <span class="text-white">COBRAN√áA</span></h1>
            <nav class="space-y-4">
                <button onclick="renderizarTabela()" class="w-full text-left p-3 rounded bg-orange text-white font-bold shadow-lg shadow-orange/20"><i class="fas fa-home mr-2"></i> Dashboard</button>
                <button onclick="openModal('modalAluno')" class="w-full text-left p-3 rounded hover:bg-slate-700 transition text-sm font-bold"><i class="fas fa-plus mr-2"></i> Novo Aluno</button>
            </nav>
            <div class="mt-10">
                <label class="text-xs uppercase text-gray-500 font-black">Filtrar Unidade</label>
                <select id="filtroUnidade" onchange="renderizarTabela()" class="w-full mt-2 bg-slate-800 border border-gray-600 p-2 rounded text-sm outline-none">
                    <option value="Todas">Todas as Unidades</option>
                    <option value="Recife">Recife</option><option value="Carpina">Carpina</option>
                    <option value="Gravat√°">Gravat√°</option><option value="Bezerros">Bezerros</option>
                    <option value="Amaraji">Amaraji</option>
                </select>
            </div>
        </aside>

        <main class="flex-1 p-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                <div class="bg-dark-blue p-5 rounded-lg border-b-4 border-orange text-center">
                    <p class="text-gray-400 text-xs uppercase font-bold">Acordos Ativos</p>
                    <h3 id="cardFechados" class="text-3xl font-black text-orange">0</h3>
                </div>
                <div class="bg-dark-blue p-5 rounded-lg border-b-4 border-blue-500 text-center">
                    <p class="text-gray-400 text-xs uppercase font-bold">Aguardando Resposta</p>
                    <h3 id="cardEnviados" class="text-3xl font-black text-blue-400">0</h3>
                </div>
            </div>

            <div class="bg-dark-blue rounded shadow-2xl overflow-hidden border border-gray-800">
                <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-slate-800/30">
                    <h2 class="font-bold text-lg">Painel de Negocia√ß√µes</h2>
                    <input type="text" id="buscaGeral" onkeyup="renderizarTabela()" placeholder="Buscar por CPF..." class="bg-slate-900 border border-gray-700 p-2 rounded text-sm w-72 outline-none focus:border-orange">
                </div>
                <table class="w-full text-left">
                    <thead class="bg-slate-800 text-xs uppercase text-gray-400 font-black">
                        <tr>
                            <th class="p-4 w-10">#</th>
                            <th class="p-4">Aluno / CPF</th>
                            <th class="p-4">Unidade</th>
                            <th class="p-4">Status / Parcelas</th>
                            <th class="p-4">Vencimento</th>
                            <th class="p-4 text-center">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="listaAlunos" class="divide-y divide-gray-800"></tbody>
                </table>
            </div>
        </main>
    </div>

    <div id="modalAluno" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-dark-blue w-full max-w-md p-6 rounded-lg border border-gray-700 shadow-2xl">
            <h2 class="text-xl font-bold text-orange mb-4 italic">Cadastrar Aluno</h2>
            <form id="formAluno" class="space-y-4">
                <input type="text" id="nome" placeholder="Nome Completo" required class="w-full bg-slate-900 border border-gray-700 p-2 rounded mt-1 uppercase outline-none focus:border-orange">
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="cpf" placeholder="CPF" oninput="maskCPF(this)" maxlength="14" required class="w-full bg-slate-900 border border-gray-700 p-2 rounded outline-none">
                    <input type="text" id="tel" placeholder="WhatsApp" oninput="maskTel(this)" maxlength="15" required class="w-full bg-slate-900 border border-gray-700 p-2 rounded outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <select id="unidade" class="w-full bg-slate-900 border border-gray-700 p-2 rounded outline-none">
                        <option value="Recife">Recife</option><option value="Carpina">Carpina</option>
                        <option value="Gravat√°">Gravat√°</option><option value="Bezerros">Bezerros</option>
                        <option value="Amaraji">Amaraji</option>
                    </select>
                    <select id="tipo" class="w-full bg-slate-900 border border-gray-700 p-2 rounded outline-none">
                        <option value="Extranet">Extranet</option><option value="PTC">PTC</option>
                    </select>
                </div>
                <div class="flex justify-end gap-3 pt-4 border-t border-gray-800">
                    <button type="button" onclick="closeModal('modalAluno')" class="text-gray-400 font-bold">Cancelar</button>
                    <button type="submit" class="bg-orange px-6 py-2 rounded font-black text-white uppercase text-sm">Salvar Aluno</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalAcordo" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-dark-blue w-full max-w-md p-6 rounded-lg border-2 border-orange shadow-2xl">
            <h2 class="text-xl font-bold text-orange mb-1 italic">Proposta Comercial</h2>
            <p id="nomeAlunoAcordo" class="text-xs text-gray-400 mb-6 font-bold uppercase"></p>
            <div class="space-y-4">
                <input type="text" id="valorAVista" onkeyup="maskDinheiro(this)" placeholder="Valor no Cart√£o R$ 0,00" class="w-full bg-slate-900 border border-gray-700 p-2 rounded text-orange font-bold outline-none">
                <input type="text" id="valorAcordo" onkeyup="maskDinheiro(this)" placeholder="Valor Total Boleto R$ 0,00" class="w-full bg-slate-900 border border-gray-700 p-2 rounded font-bold outline-none">
                <div class="grid grid-cols-3 gap-2">
                    <input type="text" id="entrada" onkeyup="maskDinheiro(this)" placeholder="Entrada" class="w-full bg-slate-900 border border-gray-700 p-2 rounded outline-none">
                    <input type="number" id="numParcelas" value="1" class="w-full bg-slate-900 border border-gray-700 p-2 rounded outline-none">
                    <input type="text" id="vlrParcelaManual" onkeyup="maskDinheiro(this)" placeholder="Vlr Parcela" class="w-full bg-slate-900 border border-gray-700 p-2 rounded outline-none text-orange font-bold">
                </div>
                <div class="flex items-center gap-2 bg-slate-800 p-3 rounded border border-gray-700">
                    <input type="checkbox" id="checkRematricula" class="w-5 h-5 accent-orange cursor-pointer">
                    <label for="checkRematricula" class="text-sm font-bold cursor-pointer">Incluir Rematr√≠cula (Emocional)</label>
                </div>
                <div class="flex justify-between gap-3 pt-4">
                    <button type="button" onclick="closeModal('modalAcordo')" class="text-gray-400 font-bold">Cancelar</button>
                    <button onclick="gerarEnviar()" class="bg-orange px-8 py-3 rounded font-black text-white uppercase text-xs shadow-lg">Enviar Proposta</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyC4_dlIiCaNHtj7eWB4kW200vnO6AuuuTA", 
            authDomain: "reguacobranca.firebaseapp.com", 
            projectId: "reguacobranca", 
            storageBucket: "reguacobranca.firebasestorage.app", 
            messagingSenderId: "85201788796", 
            appId: "1:85201788796:web:25cf11a726cec89d248ef9" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const colRef = collection(db, "negociacoes");

        window.db_local = [];
        window.idxAtivo = null;

        onAuthStateChanged(auth, user => {
            if (user) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-content').style.display = 'flex';
                ouvirBanco();
            }
        });

        document.getElementById('btnLogin').addEventListener('click', async () => {
            try { await signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPass').value); } 
            catch(e) { alert("Credenciais incorretas."); }
        });

        function ouvirBanco() {
            onSnapshot(colRef, (snapshot) => {
                window.db_local = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderizarTabela();
            });
        }

        window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.closeModal = (id) => { document.getElementById(id).classList.add('hidden'); window.idxAtivo = null; };

        window.maskCPF = (i) => {
            let v = i.value.replace(/\D/g, "");
            v = v.replace(/(\d{3})(\d)/, "$1.$2");
            v = v.replace(/(\d{3})(\d)/, "$1.$2");
            v = v.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
            i.value = v;
        };
        window.maskTel = (i) => {
            let v = i.value.replace(/\D/g, "");
            v = v.replace(/^(\d{2})(\d)/g, "($1) $2");
            v = v.replace(/(\d)(\d{4})$/, "$1-$2");
            i.value = v;
        };
        window.maskDinheiro = (i) => {
            let v = i.value.replace(/\D/g,'');
            v = (v/100).toFixed(2) + '';
            v = v.replace(".", ",");
            v = v.replace(/(\d)(\d{3})(\d{3}),/g, "$1.$2.$3,");
            v = v.replace(/(\d)(\d{3}),/g, "$1.$2,");
            i.value = "R$ " + v;
        };

        document.getElementById('formAluno').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('cpf').value.replace(/\D/g, '');
            const novo = {
                nome: document.getElementById('nome').value.toUpperCase(),
                cpf: document.getElementById('cpf').value,
                tel: document.getElementById('tel').value,
                tipo: document.getElementById('tipo').value,
                unidade: document.getElementById('unidade').value,
                status: 'Pendente',
                parcelaAtual: 0,
                marcado: false
            };
            await setDoc(doc(db, "negociacoes", id), novo);
            closeModal('modalAluno');
            e.target.reset();
        });

        window.toggleMarcador = async (id, estadoAtual) => {
            await updateDoc(doc(db, "negociacoes", id), { marcado: !estadoAtual });
        };

        window.prepararAcordo = (idx) => {
            window.idxAtivo = idx;
            document.getElementById('nomeAlunoAcordo').innerText = "Aluno: " + window.db_local[idx].nome;
            openModal('modalAcordo');
        };

        window.gerarEnviar = async () => {
            const a = window.db_local[window.idxAtivo];
            const vAV = document.getElementById('valorAVista').value;
            const vAC = document.getElementById('valorAcordo').value;
            const ent = document.getElementById('entrada').value;
            const parc = parseInt(document.getElementById('numParcelas').value);
            const vPM = document.getElementById('vlrParcelaManual').value;
            const remat = document.getElementById('checkRematricula').checked;

            const dt = new Date(); dt.setDate(dt.getDate() + 4);
            const venc = dt.toLocaleDateString('pt-BR');

            let msg = `Ol√°, *${a.nome}*! üëã\n\nIdentificamos uma oportunidade especial para regularizar sua situa√ß√£o na unidade *${a.unidade}*. Nosso objetivo √© que voc√™ continue focado no seu crescimento!\n\n`;
            if(remat) msg += `üöÄ *SEU SONHO N√ÉO PODE PARAR!*\nReativando agora, sua plataforma volta em at√© 7 dias √∫teis.\n\n`;
            msg += `üí≥ *OP√á√ÉO CART√ÉO (Libera√ß√£o entre 3 a 4 dias √∫teis):*\nDeixe tudo em dia por apenas *${vAV}* (em at√© 12x).\n\n`;
            msg += `üìÑ *OP√á√ÉO BOLETO PARCELADO (Libera√ß√£o da plataforma em at√© 7 dias √∫teis):*\nEntrada de *${ent}* + *${parc}x* de *${vPM}*.\n\n`;
            msg += `üìÖ *Vencimento da Entrada:* ${venc}\n\nPara fechar agora e garantir essa condi√ß√£o, responda *SIM*.`;

            await updateDoc(doc(db, "negociacoes", a.id), { 
                status: 'Enviado', 
                fin: {venc, totalParcelas: parc, valorParcela: vPM, valorAcordo: vAC} 
            });
            
            closeModal('modalAcordo');
            window.open(`https://api.whatsapp.com/send?phone=55${a.tel.replace(/\D/g,'')}&text=${encodeURIComponent(msg)}`);
        };

        window.enviarProximaParcela = async (idx) => {
            const a = window.db_local[idx];
            const prox = (a.parcelaAtual || 0) + 1;
            if (prox > a.fin.totalParcelas) return alert("Acordo 100% quitado!");

            const msg = `Ol√°, *${a.nome}*! üëã\n\nEsperamos que esteja tudo bem com seus estudos! Segue o boleto da sua parcela *${prox}/${a.fin.totalParcelas}* do acordo firmado com a unidade *${a.unidade}*.\n\nüí∞ *Valor:* ${a.fin.valorParcela}\n\nüîó Voc√™ tamb√©m pode localizar todas as suas parcelas e o hist√≥rico financeiro diretamente em nosso portal oficial:\nhttps://www.vaiqta.com.br/\n\nBons estudos! üìö`;
            
            const novoVenc = new Date();
            novoVenc.setDate(novoVenc.getDate() + 30);
            
            await updateDoc(doc(db, "negociacoes", a.id), { 
                parcelaAtual: prox,
                "fin.venc": novoVenc.toLocaleDateString('pt-BR')
            });
            window.open(`https://api.whatsapp.com/send?phone=55${a.tel.replace(/\D/g,'')}&text=${encodeURIComponent(msg)}`);
        };

        window.confirmar = async (idx) => {
            if(confirm("Confirmar fechamento? O sistema iniciar√° o controle de mensalidades.")) {
                await updateDoc(doc(db, "negociacoes", window.db_local[idx].id), { status: 'Confirmado', parcelaAtual: 0 });
            }
        };

        window.excluirAluno = async (idx) => {
            if(confirm("Excluir registro permanentemente?")) await deleteDoc(doc(db, "negociacoes", window.db_local[idx].id));
        };

        window.renderizarTabela = () => {
            const lista = document.getElementById('listaAlunos');
            const filtroU = document.getElementById('filtroUnidade').value;
            const busca = document.getElementById('buscaGeral').value.replace(/\D/g, '');
            lista.innerHTML = "";
            let f=0, e=0;

            window.db_local.forEach((a, idx) => {
                if(filtroU !== "Todas" && a.unidade !== filtroU) return;
                const cpfLimpo = a.cpf ? a.cpf.replace(/\D/g, '') : '';
                if(busca && !cpfLimpo.includes(busca)) return;

                if(a.status === 'Confirmado') f++;
                if(a.status === 'Enviado') e++;

                let sBadge = `<span class="text-gray-500 font-bold italic text-[10px]">Pendente</span>`;
                if(a.status === 'Enviado') sBadge = `<span class="text-blue-400 font-bold italic text-[10px]">Aguardando</span>`;
                if(a.status === 'Confirmado') {
                    const p = a.parcelaAtual || 0;
                    const t = a.fin ? a.fin.totalParcelas : 0;
                    sBadge = `<span class="text-green-500 font-black text-[10px]">ATIVO: ${p}/${t}</span>`;
                }

                const isMarcado = a.marcado ? 'text-orange' : 'text-gray-700';

                lista.innerHTML += `
                    <tr class="hover:bg-slate-800 transition border-b border-gray-800 text-sm ${a.marcado ? 'bg-orange/5' : ''}">
                        <td class="p-4">
                            <button onclick="toggleMarcador('${a.id}', ${a.marcado || false})" class="${isMarcado} hover:scale-110 transition">
                                <i class="fas fa-bookmark fa-lg"></i>
                            </button>
                        </td>
                        <td class="p-4">
                            <div class="font-bold uppercase">${a.nome}</div>
                            <div class="text-[10px] text-gray-400 font-mono">${a.cpf || ''}</div>
                        </td>
                        <td class="p-4 text-xs">${a.unidade}</td>
                        <td class="p-4">${sBadge}</td>
                        <td class="p-4 text-xs">${a.fin ? a.fin.venc : '---'}</td>
                        <td class="p-4 flex justify-center gap-4">
                            ${a.status === 'Confirmado' ? 
                                `<button onclick="enviarProximaParcela(${idx})" class="text-blue-400"><i class="fas fa-paper-plane fa-lg"></i></button>` : 
                                `<button onclick="prepararAcordo(${idx})" class="text-orange"><i class="fas fa-handshake fa-lg"></i></button>`
                            }
                            <button onclick="confirmar(${idx})" class="text-green-500"><i class="fas fa-check-double fa-lg"></i></button>
                            <button onclick="excluirAluno(${idx})" class="text-red-900"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
            });
            document.getElementById('cardFechados').innerText = f;
            document.getElementById('cardEnviados').innerText = e;
        };
    </script>
</body>
</html>
